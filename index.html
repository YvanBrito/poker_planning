<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Poker Planning</title>
    <style>
      body {
        font-family: sans-serif;
      }
      .estimates {
        margin-top: 20px;
      }
      .card {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 5px;
        display: inline-block;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <!--https://lovable.dev/projects/cd25c323-4430-4ada-b1a8-400662b4d2e3-->
    <h1>Poker Planning</h1>
    <p>Acesse a sala com o parâmetro `?room=nome-da-sala`</p>
    <p>Exemplo: `ws://localhost:8080/ws?room=sala123`</p>

    <form id="joinForm">
      <input type="text" id="username" placeholder="Seu nome" required />
      <button type="submit">Entrar</button>
    </form>

    <div id="game" style="display: none">
      <p>Sua estimativa: <span id="myEstimate"></span></p>
      <div class="estimates">
        <h2>Estimativas</h2>
        <div id="estimatesList"></div>
      </div>
      <button onclick="revealEstimates()">Revelar</button>
      <button onclick="resetEstimates()">Zerar</button>
      <div id="membersList"></div>
    </div>

    <script>
      let socket
      let username
      const urlParams = new URLSearchParams(window.location.search)
      const roomName = urlParams.get('room')

      if (!roomName) {
        alert('Por favor, acesse a URL com o parâmetro ?room=nome-da-sala')
      }

      document.getElementById('joinForm').onsubmit = (event) => {
        event.preventDefault()
        username = document.getElementById('username').value
        document.getElementById('joinForm').style.display = 'none'
        document.getElementById('game').style.display = 'block'

        socket = new WebSocket(`ws://localhost:8080/ws?room=${roomName}`)

        socket.onopen = () => {
          console.log('Conectado à sala:', roomName)
          socket.send(
            JSON.stringify({
              type: 'join',
              username: username,
            }),
          )
        }

        socket.onmessage = (event) => {
          const state = JSON.parse(event.data)
          updateUI(state)
        }

        socket.onclose = () => {
          console.log('Desconectado.')
        }
      }

      function updateUI(state) {
        const estimatesList = document.getElementById('estimatesList')
        estimatesList.innerHTML = ''
        for (const user in state.estimates) {
          const card = document.createElement('div')
          card.className = 'card'
          card.textContent = `${user}: ${state.estimates[user]}`
          estimatesList.appendChild(card)
        }

        if (state.estimates[username]) {
          document.getElementById('myEstimate').textContent =
            state.estimates[username]
        }

        const membersList = document.getElementById('membersList')
        membersList.innerHTML = '<h3>Membros</h3>'
        state.members.forEach((member) => {
          const li = document.createElement('li')
          li.textContent = member
          membersList.appendChild(li)
        })
      }

      function sendEstimate(value) {
        if (socket) {
          socket.send(
            JSON.stringify({
              type: 'estimate',
              username: username,
              value: value,
            }),
          )
        }
      }

      function revealEstimates() {
        if (socket) {
          socket.send(
            JSON.stringify({
              type: 'reveal',
              username: username,
            }),
          )
        }
      }

      function resetEstimates() {
        if (socket) {
          socket.send(
            JSON.stringify({
              type: 'reset',
              username: username,
            }),
          )
        }
      }
    </script>

    <div style="margin-top: 20px">
      <p>Selecione sua estimativa:</p>
      <button onclick="sendEstimate('PP')">PP</button>
      <button onclick="sendEstimate('P')">P</button>
      <button onclick="sendEstimate('M')">M</button>
      <button onclick="sendEstimate('G')">G</button>
      <button onclick="sendEstimate('GG')">GG</button>
      <button onclick="sendEstimate('?')">?</button>
    </div>
  </body>
</html>
